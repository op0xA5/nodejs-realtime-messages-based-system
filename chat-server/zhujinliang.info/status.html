<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Server Status</title>
<script src="jquery.js"></script>
<script>
var hTimer, functions={};
$(function(){
	$('#refresh').change(function(){
		if(hTimer) clearInterval(hTimer);
		var interval = parseInt($(this).val());
		if(interval){
			hTimer = setInterval(function(){
				$.getJSON('http://zhujinliang.info:81/status?json&'+Math.random(), function(data){
					putData(data);
				});
			}, interval*1000);
		}
	}).change();
	$.getJSON('http://zhujinliang.info:81/status?json&'+Math.random(), function(data){
		putData(data);
	});
});

function putData(data){
	$('#statInfo .statVal').each(function(){
		var s=$(this).attr('node').split('.');
		var o=data;
		for(var i in s){
			if(s[i] in o){
				o=o[s[i]];
			}else{
				o=null;
				break;
			}
		}
		var f=$(this).attr('func');
		if(f && f in functions){
			$(this).text(functions[f](o));
		}else{
			var u=$(this).attr('unit');
			if(u){
				$(this).text(o+' '+u);
			}else{
				$(this).text(o);
			}
		}
	});
}

function uFormat(num, units, dec){
	var rtn='',i;	
	if(dec && dec > -1){
		var c=oc=1, oi;
		for(i in units){
			if(num < c) break;
			oi=i;
			c = (oc=c) * units[i];
		}
		var p=Math.pow(10,dec);
		rtn = Math.round(num/oc*p)/p+' '+(oi||i);
	}else{
		for(i in units){
			if(num > units[i]){
				var m=num%units[i];
				var num=(num-m)/units[i];
				rtn = ' '+m+' '+i+rtn;
			}else{
				rtn = num+' '+i+rtn;
				break;
			}
		}
	}
	return rtn;
}

functions.timeFormat=function(t){
	return uFormat(t, {
		'秒' : 60,
		'分' : 60,
		'时' : 60,
		'天' : 24
	});
};
functions.lengthFromat=function(t){
	return uFormat(t, {
		'B' : 1024,
		'KB' : 1024,
		'MB' : 1024,
		'GB' : 1024
	}, 2);
}
</script>
<style>
body, table, div { font-size:11px;}
#statInfo {border-left:1px #666 solid; border-top:1px #666 solid;}
#statInfo td {padding:2px 6px; border-right:1px #666 solid; border-bottom:1px #666 solid;}
#statInfo .title {padding:2px 6px; border-right:none !important; border-bottom:1px #666 solid; text-align:right;}
</style>
</head>

<body>
<table id="statInfo" width="600" cellpadding="0" cellspacing="0">
  <tr>
    <td width="150">服务器时间</td>
    <td width="444"><span class="statVal" node="serverTime">${serverTime}</span></td>
  </tr>
  <tr>
    <td>在线时间</td>
    <td><span class="statVal" node="onlineTime" func="timeFormat">${onlineTime} s</span></td>
  </tr>
  <tr>
    <td class="title">HTTP服务器</td>
    <td></td>
  </tr>
  <tr>
    <td>在线TCP链接数</td>
    <td><span class="statVal" node="http.onlineConnections">${http.onlineConnections}</span></td>
  </tr>
  <tr>
    <td>TCP链接数</td>
    <td><span class="statVal" node="http.connections">${http.connections}</span></td>
  </tr>
  <tr>
    <td>请求数</td>
    <td><span class="statVal" node="http.requests">${http.requests}</span></td>
  </tr>
  <tr>
    <td>接收数据</td>
    <td><span class="statVal" node="http.receiveBytes" func="lengthFromat">${http.receiveBytes} bytes</span></td>
  </tr>
  <tr>
    <td>发送数据</td>
    <td><span class="statVal" node="http.sendBytes" func="lengthFromat">${http.sendBytes} bytes</span></td>
  </tr>
  <tr>
    <td>错误的访问路径</td>
    <td><span class="statVal" node="http.notHandled">${http.notHandled}</span></td>
  </tr>
  <tr>
    <td>错误计数</td>
    <td><span class="statVal" node="http.errors">${http.errors}</span></td>
  </tr>
  <tr>
    <td class="title">链接池</td>
    <td></td>
  </tr>
  <tr>
    <td>在线链接</td>
    <td><span class="statVal" node="connections.online">${connections.online}</span></td>
  </tr>
  <tr>
    <td>总计进入链接</td>
    <td><span class="statVal" node="connections.totalIncome">${connections.totalIncome}</span></td>
  </tr>
  <tr>
    <td>丢弃的链接数</td>
    <td><span class="statVal" node="connections.incomeDropped">${connections.incomeDropped}</span></td>
  </tr>
  <tr>
    <td>进入的消息数</td>
    <td><span class="statVal" node="connections.incomeMessages">${connections.incomeMessages}</span></td>
  </tr>
  <tr>
    <td>发出的消息数</td>
    <td><span class="statVal" node="connections.sendMessages">${connections.sendMessages}</span></td>
  </tr>
  <tr>
    <td>丢弃的消息数</td>
    <td><span class="statVal" node="connections.droppedMessages">${connections.droppedMessages}</span></td>
  </tr>
  <tr>
    <td>错误的消息数</td>
    <td><span class="statVal" node="connections.errorMessages">${connections.errorMessages}</span></td>
  </tr>
</table>
刷新频率
<select id="refresh">
    <option value="0">暂停</option>
    <option value="1">1s</option>
    <option value="5">5s</option>
    <option value="10" selected="selected">10s</option>
    <option value="30">30s</option>
    <option value="60">1min</option>
</select>
</body>
</html>
